# Архитектурный отчёт по SAGE Engine

Этот документ анализирует текущую структуру проекта и проверяет, насколько она соответствует принципам модульности и расширяемости.

## Введение

SAGE Engine построен по фазовой модели: `boot -> update -> draw -> flush -> shutdown`【F:docs/architecture.md†L21-L25】. Каждый модуль регистрируется в `core` через `core.register` и выполняет свои обратные вызовы по фазам【F:docs/structure.md†L239-L246】.

## Обзор модулей и зависимостей

Основные каталоги перечислены в [structure.md](../structure.md). Они включают `core`, `render`, `gfx`, `input`, `flow`, `resource`, `world` и другие【F:docs/structure.md†L156-L199】. Существующие связи отображены на диаграмме `architecture.svg`.

```text
core -> window
core -> render
core -> gfx
core -> input
core -> flow
core -> resource
core -> world
render -> gfx
window -> input
world -> flow
```

Диаграмма показывает, что `core` зависит почти от всех подсистем, а `gfx` и `window` имеют двустороннюю связь через события и запросы размера окна.

## Обнаруженные недостатки

- **Тесная связка gfx и window.** В файле `gfx/runtime.py` модуль напрямую запрашивает размеры окна и пересоздаёт буфер, что создаёт жёсткую зависимость от модуля окна【F:sage_engine/gfx/runtime.py†L22-L33】.
- **Неполные реализации вводов.** В каталогах `input/impl/x11.py` и `input/impl/cocoa.py` содержатся только заглушки без полной логики, поэтому движок фактически работает только под Win32【F:sage_engine/input/impl/x11.py†L1-L6】.
- **Смешение ролей и миров.** Каталог `world` управляет сценой и объектами, но чёткие границы ответственности между `world`, `objects` и `roles` не определены, что усложняет расширение системы сцен【F:docs/structure.md†L172-L199】.
- **Нет явной изоляции между модулями.** Хотя правила декларируют работу через `core.register`, многие модули импортируют функции друг друга напрямую, например `gfx` использует `window.get_framebuffer_size` и `render` вызывает `gfx` напрямую. Это нарушает принцип слабой связи.

## Минусы структуры

Структура каталогов в целом последовательна, однако присутствуют файлы с частичным дублированием API. Некоторые директории, такие как `graphic` и `gfx`, имеют схожие функции, что может запутать новых разработчиков. Документация предупреждает, что изменения структуры должны синхронно обновляться вместе с этим файлом【F:docs/structure.md†L268-L270】.

## Выводы

Архитектура SAGE Engine придерживается идей модульности, но фактические зависимости между модулями сильнее, чем описано. Большинство компонентов напрямую обращаются к соседним подсистемам. Отсутствие полной реализации кроссплатформенного ввода и чётких границ мира снижает расширяемость.

## Рекомендации

1. Ввести фасадные интерфейсы для `window` и `gfx`, чтобы исключить прямые импорты.
2. Завершить реализацию X11 и Cocoa в модуле `input`.
3. Разделить логику `world`, `objects` и `roles` на отдельные сервисы с чётким API.
4. Проверять новые модули на циклические зависимости и описывать их в документации.

Дополнительные проблемы и их приоритеты перечислены в [architecture_findings.csv](architecture_findings.csv).
