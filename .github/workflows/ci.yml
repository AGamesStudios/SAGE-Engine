name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  windows:
    name: Windows - ${{ matrix.compiler }} - ${{ matrix.config }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [msvc]
        config: [Debug, Release]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2
      
      - name: Configure CMake
        run: >-
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64
          -DSAGE_BUILD_TESTS=ON
          -DSAGE_BUILD_EXAMPLES=ON
          -DSAGE_STRICT_WARNINGS=ON
      
      - name: Build ${{ matrix.config }}
        run: cmake --build build --config ${{ matrix.config }} --parallel
      
      - name: Run Tests (${{ matrix.config }})
        run: |
          cd build\bin\${{ matrix.config }}
          if (Test-Path ".\SAGETests.exe") {
            .\SAGETests.exe
          } else {
            Write-Error "SAGETests.exe not found"
            exit 1
          }
        shell: pwsh
      
      - name: Upload Artifacts (${{ matrix.config }})
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.compiler }}-${{ matrix.config }}
          retention-days: 7
          path: |
            build/lib/${{ matrix.config }}/SAGE_Engine.lib
            build/bin/${{ matrix.config }}/*.exe

  linux:
    name: Linux - ${{ matrix.compiler }} - ${{ matrix.config }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        config: [Debug, Release]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            xvfb \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libasound2-dev
      
      - name: Setup Compiler (GCC)
        if: matrix.compiler == 'gcc'
        run: |
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV
      
      - name: Setup Compiler (Clang)
        if: matrix.compiler == 'clang'
        run: |
          sudo apt-get install -y clang
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
      
      - name: Configure CMake
        run: >-
          cmake -S . -B build -G Ninja
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DSAGE_BUILD_TESTS=ON
          -DSAGE_BUILD_EXAMPLES=ON
          -DSAGE_STRICT_WARNINGS=ON
      
      - name: Build ${{ matrix.config }}
        run: cmake --build build --parallel
      
      - name: Run Tests (${{ matrix.config }})
        run: |
          cd build/bin
          if [ -f "./SAGETests" ]; then
            xvfb-run --auto-servernum ./SAGETests
          else
            echo "SAGETests not found"
            exit 1
          fi
      
      - name: Upload Artifacts (${{ matrix.config }})
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.compiler }}-${{ matrix.config }}
          retention-days: 7
          path: |
            build/lib/libSAGE_Engine.a
            build/bin/*
