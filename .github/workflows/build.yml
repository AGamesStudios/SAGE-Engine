name: Build SAGE Engine

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake
      run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64
    
    - name: Build Release
      run: cmake --build build --config Release --parallel
    
    - name: Build Debug
      run: cmake --build build --config Debug --parallel
    
    - name: Run Tests (Release)
      run: |
        cd build/bin/Release
        if (Test-Path "./Tests.exe") {
          ./Tests.exe
        } else {
          Write-Host "Tests.exe not found, skipping tests"
        }
      shell: pwsh
      continue-on-error: true
    
    - name: Package Artifacts
      run: |
        New-Item -ItemType Directory -Force -Path artifacts/windows
        Copy-Item -Path "build/lib/Release/SAGE_Engine.lib" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "build/lib/Debug/SAGE_Engine.lib" -Destination "artifacts/windows/SAGE_Engine_Debug.lib" -ErrorAction SilentlyContinue
        Copy-Item -Path "Engine" -Destination "artifacts/windows/include/Engine" -Recurse
        Copy-Item -Path "ThirdParty" -Destination "artifacts/windows/ThirdParty" -Recurse
        Copy-Item -Path "README.md" -Destination "artifacts/windows/"
        Copy-Item -Path "LICENSE" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Compress-Archive -Path "artifacts/windows/*" -DestinationPath "SAGE-Engine-Windows.zip"
      shell: pwsh
    
    - name: Create Release Package
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        powershell -ExecutionPolicy Bypass -File tools/package_release.ps1 -Configuration Release -OutputDir release_package
      shell: pwsh
    
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SAGE-Engine-Windows
        path: SAGE-Engine-Windows.zip
        retention-days: 30
    
    - name: Upload to GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release_package/*.zip
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        body_path: RELEASE_README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Linux Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libgl1-mesa-dev
    
    - name: Configure CMake
      run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
    
    - name: Build Release
      run: cmake --build build --parallel
    
    - name: Build Debug
      run: |
        cmake -S . -B build-debug -G Ninja -DCMAKE_BUILD_TYPE=Debug
        cmake --build build-debug --parallel
    
    - name: Run Tests (Release)
      run: |
        cd build/bin
        if [ -f "./Tests" ]; then
          ./Tests
        else
          echo "Tests executable not found, skipping tests"
        fi
      continue-on-error: true
    
    - name: Package Artifacts
      run: |
        mkdir -p artifacts/linux
        cp build/lib/libSAGE_Engine.a artifacts/linux/ 2>/dev/null || true
        cp build-debug/lib/libSAGE_Engine.a artifacts/linux/libSAGE_Engine_Debug.a 2>/dev/null || true
        cp -r Engine artifacts/linux/include/
        cp -r ThirdParty artifacts/linux/
        cp README.md artifacts/linux/
        cp LICENSE artifacts/linux/ 2>/dev/null || true
        cd artifacts && tar -czf ../SAGE-Engine-Linux.tar.gz linux/
    
    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SAGE-Engine-Linux
        path: SAGE-Engine-Linux.tar.gz
        retention-days: 30

  create-release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download Windows Artifacts
      uses: actions/download-artifact@v4
      with:
        name: SAGE-Engine-Windows
    
    - name: Download Linux Artifacts
      uses: actions/download-artifact@v4
      with:
        name: SAGE-Engine-Linux
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.date.outputs.date }}-${{ github.sha }}
        name: SAGE Engine Build ${{ steps.date.outputs.date }}
        body: |
          Automated build from commit ${{ github.sha }}
          
          ## Downloads
          - **Windows**: SAGE-Engine-Windows.zip
          - **Linux**: SAGE-Engine-Linux.tar.gz
          
          ## Changes
          ${{ github.event.head_commit.message }}
        files: |
          SAGE-Engine-Windows.zip
          SAGE-Engine-Linux.tar.gz
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
